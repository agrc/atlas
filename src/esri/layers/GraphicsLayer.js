//>>built
define(["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/dom-attr","dojo/dom-construct","dojo/dom-style","dojox/gfx","dojox/gfx/matrix","esri/kernel","esri/lang","esri/sniff","esri/domUtils","esri/layers/layer","esri/symbols/MarkerSymbol","esri/symbols/SimpleMarkerSymbol","esri/geometry/Point","esri/geometry/ScreenPoint","esri/geometry/Extent","esri/geometry/mathUtils","esri/geometry/screenUtils"],function(x,q,y,m,I,N,G,A,u,T,P,H,C,U,V,w,Q,J,B,R,K){var L,M=-1!==A.renderer.toLowerCase().indexOf("svg"),
D=-1!==A.renderer.toLowerCase().indexOf("canvas"),t=9>H("ie"),S=H("esri-touch"),W=x(null,{declaredClass:"esri.layers._GraphicsContainer",_setMap:function(a,b){var c,d=this._connects=[];this._map=a;D?(c=N.create("div",{style:"overflow: visible; position: absolute;"},b),this._surface={getEventSource:function(){return c}},d.push(q.connect(c,"onmousedown",this,this._canvasDownHandler)),d.push(q.connect(c,"onmouseup",this,this._canvasUpHandler)),d.push(q.connect(c,"onclick",this,this._canvasClickHandler)),
L.prototype._canvas=!0):(c=(this._surface=A.createSurface(b,a.width,a.height)).getEventSource(),G.set(c=t?c.parentNode:c,{overflow:"visible",position:"absolute"}));d.push(q.connect(a,"onResize",this,"_onResizeHandler"));return c},_onResizeHandler:function(a,b,c){a=this._surface.getEventSource();var d=this._map,e;t&&G.set(a=a.parentNode,{width:b+"px",height:c+"px",clip:"rect(0px "+b+"px "+c+"px 0px)"});I.set(a,"width",b);I.set(a,"height",c);this._surface.declaredClass||m.forEach(a.childNodes,function(a){I.set(a,
"width",b);I.set(a,"height",c)});d.loaded&&(d.graphics.suspended||(d.graphics._resized=!0),m.forEach(d.graphicsLayerIds,function(a){e=d.getLayer(a);e.suspended||(e._resized=!0)}))},_cleanUp:function(){m.forEach(this._connects,q.disconnect,q);this._map=this._surface=null},_processEvent:function(a){var b=this._map;a.screenPoint=new J(a.pageX-b.position.x,a.pageY-b.position.y);a.mapPoint=b.toMap(a.screenPoint)},_canvasDownHandler:function(a){this._processEvent(a);this._downPt=a.screenPoint.x+","+a.screenPoint.y},
_canvasUpHandler:function(a){this._processEvent(a);this._upPt=a.screenPoint.x+","+a.screenPoint.y},_tolerance:15,_isPrimaryMatch:function(a,b,c,d){if(!a.visible||!b)return!1;var e=b.getTransformedBoundingBox(),f;return e?(f=new B(e[0].x,e[0].y,e[2].x,e[2].y),delete f.spatialReference,S?f.intersects(c):f.contains(d)):m.some(b.children||[],function(a){e=a.getTransformedBoundingBox();f=new B(e[0].x,e[0].y,e[2].x,e[2].y);delete f.spatialReference;return S?f.intersects(c):f.contains(d)})},_canvasClickHandler:function(a){if(this._downPt&&
this._upPt&&this._downPt===this._upPt){this._processEvent(a);var b=this._map,c=m.map(b.graphicsLayerIds,function(a){return b.getLayer(a)});c.push(b.graphics);c.reverse();var c=m.filter(c,function(a){return a.loaded&&a._mouseEvents&&!a.suspended&&(!P.isDefined(a.opacity)||0<a.opacity)}),d=a.screenPoint,e=this._tolerance,f=d.x-e,g=d.y+e,h=d.x+e,e=d.y-e,k=new B(f,e,h,g),f=b.toMap(new J(f,g)),h=b.toMap(new J(h,e)),g=f.spatialReference._getInfo(),l=new B(B.prototype._normalizeX(f.x,g).x,f.y,B.prototype._normalizeX(h.x,
g).x,h.y,f.spatialReference),p;delete k.spatialReference;m.some(c,function(a){a=m.filter(a.graphics,function(a){return this._isPrimaryMatch(a,a.getDojoShape(),k,d)||!(!a._bgShape||!this._isPrimaryMatch(a,a._bgShape,k,d))},this);a.reverse();if(0<a.length){var c;m.some(a,function(a){return a.geometry&&l.intersects(a.geometry)?(c=a,!0):!1});if(c)return p=c,!0}return!1},this);if(p&&(c=p.getLayer()))a.graphic=p,c.onClick(a)}}});L=x(U,{declaredClass:"esri.layers._GraphicsLayer",managedSuspension:!0,surfaceType:D?
"canvas-2d":A.renderer,_eventMap:{"graphic-add":["graphic"],"graphic-remove":["graphic"]},constructor:function(a,b){if(a&&(y.isString(a)||y.isObject(a)&&a.layerDefinition))a=b;this._params=y.mixin({displayOnPan:!0,drawMode:!0,styling:!0},a||{});var c=this._params.dataAttributes;"string"===typeof c&&(c=[c]);this.styling=M?this._params.styling:!0;this.dataAttributes=c;this.infoTemplate=a&&a.infoTemplate;this.graphics=[];this._draw=y.hitch(this,this._draw);this._refresh=y.hitch(this,this._refresh);this.registerConnectEvents()},
getNode:function(){return this._div&&this._div.getEventSource()},setDrawMode:function(a){this._params.drawMode=a},renderer:null,_setMap:function(a,b){this.inherited(arguments);this._map=a;this._wrap=a.wrapAround180;this._srInfo=a.spatialReference._getInfo();this._canvas?(b=A.createSurface(b.getEventSource(),a.width,a.height),G.set(b.rawNode,"position","absolute"),this._div=b.createGroup(),this._renderProto=this._div.constructor.prototype._render,this._div._render=y.hitch(this,this._canvasRender)):
this._div=b.createGroup();this._bgGroup=this._div.createGroup();this._div.getEventSource().id=this.id+"_layer";var c=this.opacity;P.isDefined(c)&&1>c&&this.setOpacity(c,!0);return this._div},_unsetMap:function(a,b){m.forEach(this.graphics,function(a){a._shape=null});this._canvas?(b=this._div.getParent(),b._parent={},N.destroy(b.rawNode),b.destroy()):(this._div.clear(),b.remove(this._div),N.destroy(this._div.getEventSource()));this._map=this._div=null;clearTimeout(this._wakeTimer);this._wakeTimer=
null;this._disableDrawConnectors();this.inherited(arguments)},_onZoomStartHandler:function(){C.hide(this._div.getEventSource())},_onExtentChangeHandler:function(a,b,c,d){clearTimeout(this._wakeTimer);this._wakeTimer=null;c?(a=this._map.__visibleRect,b=this._div,this._evalSDRenderer(),this._refresh(!0),b.setTransform(u.translate({x:a.x,y:a.y})),this._renderProto&&b.surface.pendingRender?this._dirty=!0:this.suspended||C.show(b.getEventSource())):this._resized&&(this._refresh(!1),this._resized=!1);if(0<
this.graphics.length)this.onUpdate()},_canvasRender:function(){var a=this._div;this._dirty&&(delete this._dirty,this.suspended||C.show(a.getEventSource()));return this._renderProto.apply(a,arguments)},_refresh:function(a){var b=this.graphics,c=b.length,d,e=this._draw;for(d=0;d<c;d++)e(b[d],a)},refresh:function(){this._refresh(!0)},redraw:function(){this._refresh(!0)},_onPanHandler:function(a,b){this._panDx=b.x;this._panDy=b.y;var c=this._map.__visibleRect;this._div.setTransform(u.translate({x:c.x+
b.x,y:c.y+b.y}))},_onPanEndUpdateHandler:function(a,b){if(!this._params._child&&(b.x!==this._panDx||b.y!==this._panDy)){var c=this._map.__visibleRect;this._div.setTransform(u.translate({x:c.x,y:c.y}))}this._refresh(!1);if(this.graphics.length)this.onUpdate()},_onPanStartHandler:function(){C.hide(this._div.getEventSource())},_onPanEndHandler:function(){var a=this._map.__visibleRect,b=this._div;b.setTransform(u.translate({x:a.x,y:a.y}));this._refresh(!1);this._renderProto&&b.surface.pendingRender?this._dirty=
!0:C.show(b.getEventSource());if(this.graphics.length)this.onUpdate()},onSuspend:function(){this.inherited(arguments);C.hide(this._div.getEventSource());clearTimeout(this._wakeTimer);this._wakeTimer=null;this._disableDrawConnectors()},onResume:function(a){this.inherited(arguments);a.firstOccurrence&&this._evalSDRenderer();this._enableDrawConnectors();this._wakeTimer=this._wakeTimer||setTimeout(y.hitch(this,function(){this.suspended||this._onExtentChangeHandler(null,null,!0)}),0)},_enableDrawConnectors:function(){var a=
this._map,b=q.connect;this._disableDrawConnectors();this._params.displayOnPan?(this._params._child||(this._onPanHandler_connect=b(a,"onPan",this,"_onPanHandler")),this._onPanEndHandler_connect=b(a,"onPanEnd",this,"_onPanEndUpdateHandler")):(this._onPanStartHandler_connect=b(a,"onPanStart",this,"_onPanStartHandler"),this._onPanEndHandler_connect=b(a,"onPanEnd",this,"_onPanEndHandler"));this._onZoomStartHandler_connect=b(a,"onZoomStart",this,"_onZoomStartHandler");this._onExtentChangeHandler_connect=
b(a,"onExtentChange",this,"_onExtentChangeHandler")},_disableDrawConnectors:function(){var a=q.disconnect;a(this._onExtentChangeHandler_connect);a(this._onZoomStartHandler_connect);a(this._onPanHandler_connect);a(this._onPanStartHandler_connect);a(this._onPanEndHandler_connect);this._onExtentChangeHandler_connect=this._onZoomStartHandler_connect=this._onPanHandler_connect=this._onPanStartHandler_connect=this._onPanEndHandler_connect=null},_updateExtent:function(a){var b=a.geometry;if(b){if(!(a._extent=
b.getExtent())){var c,d;if("esri.geometry.Point"===b.declaredClass)c=b.x,d=b.y;else if("esri.geometry.Multipoint"===b.declaredClass)c=b.points[0][0],d=b.points[0][1];else{a._extent=null;return}a._extent=new B(c,d,c,d,b.spatialReference)}}else a._extent=null},_intersects:function(a,b,c){var d=a.spatialReference,e=b.spatialReference,f=d&&e&&!d.equals(e)&&d._canProject(e)&&4326===e.wkid;if(this._wrap&&!c){c=[];var d=a._getFrameWidth(),g=this._srInfo,h=a._clip?a._getAvailExtent():a.extent,k,l,p,n,O=[];
k=b._partwise;f&&(h=a.geographicExtent,g=e._getInfo());a=h._getParts(g);if(k&&k.length){b=[];e=0;for(f=k.length;e<f;e++)b=b.concat(k[e]._getParts(g))}else b=b._getParts(g);e=0;for(f=b.length;e<f;e++){p=b[e];g=0;for(h=a.length;g<h;g++)if(n=a[g],n.extent.intersects(p.extent)){k=0;for(l=p.frameIds.length;k<l;k++)c.push((n.frameIds[0]-p.frameIds[k])*d)}}e=0;for(f=c.length;e<f;e++)k=c[e],m.indexOf(c,k)===e&&O.push(k);return O.length?O:null}return(f?a.geographicExtent:a.extent).intersects(b)?[0]:null},
_defaultMarker:{type:"simplemarkersymbol",style:"square",size:1,xoffset:0,yoffset:0,angle:0},_draw:function(a,b){if(this._params.drawMode&&this._map&&!this.suspended)try{var c=a._extent,d,e,f=!M||this.styling,g=M&&this.dataAttributes,h=a.getDojoShape(),k;if(a.visible&&c&&(d=this._intersects(this._map,c,a.geometry._originOnly))&&(e=f?this._getSymbol(a):this._defaultMarker)){if(!a._offsets||a._offsets.join(",")!==d.join(",")?a._offsets=d:k=!0,!h||b||!k){var l=a.geometry.type,c={graphic:a},p=a._bgShape,
n=f&&!a.symbol?this._getRenderer(a):null,m=n&&n.backgroundFillSymbol;if("point"===l)this._isInvalidShape(e,h)&&this._removeShape(a),a._shape=this._drawPoint(this._div,a.geometry,e,a.getDojoShape(),d,n,a),f&&this._symbolizePoint(a.getDojoShape(),e,n,a);else if("multipoint"===l)this._drawMarkers(a,e,d,n),f&&this._symbolizeMarkers(a,e,n);else{var v,l=e,E,F;f&&(l=(v=e.isInstanceOf(V)?e:null)?m:e);l&&l===m&&(E=this._bgGroup);p&&!E&&this._removeBgShape(a);l&&(!E&&this._isInvalidShape(l,a._shape)&&this._removeShape(a,
!1),F=this._drawShape(a,d,E||this._div,E?p:a.getDojoShape()),this._symbolizeShape(F,l,!m&&n,a),a[E?"_bgShape":"_shape"]=F);v&&(this._isInvalidShape(v,a._shape)&&this._removeShape(a,!1),F=this._drawPoint(this._div,a.geometry.getCentroid(),v,a._shape,d,n,a),this._symbolizePoint(F,v,n,a),a._shape=F)}D||(a._bgShape&&this._initNode(a,a._bgShape,a._bgShape!==p,c,g),a._shape&&this._initNode(a,a._shape,a._shape!==h,c,g));this.onGraphicDraw(c)}}else h&&this._removeShape(a)}catch(X){this._errorHandler(X,a)}},
_initNode:function(a,b,c,d,e){if(b=b&&b.getNode())b.e_graphic=a,this._addDataAttrs(a,e,b),c&&(d.node=b,this.onGraphicNodeAdd(d))},_removeShape:function(a,b){var c=a.getDojoShape(),d=c&&c.getNode();c&&(c.removeShape(),c.destroy());a._shape=a._offsets=null;!1!==b&&this._removeBgShape(a);if(d&&(d.e_graphic=null,!D))this.onGraphicNodeRemove({graphic:a,node:d})},_removeBgShape:function(a){var b=a._bgShape,c=b&&b.getNode();b&&(b.removeShape(),b.destroy(),a._bgShape=null);if(c&&(c.e_graphic=null,!D))this.onGraphicNodeRemove({graphic:a,
node:c})},_addDataAttrs:function(a,b,c){var d=a.attributes,e,f=b?b.length:0,g=this._getRenderer(a);if(c&&d){for(e=0;e<f;e++)(c=b[e])&&a.attr("data-"+c,d[c]);!this.styling&&g&&(g.getBreakIndex?(b=g.getBreakIndex(a),a.attr("data-class-break",-1!==b?b:null)):g.getUniqueValueInfo&&(b=g.getUniqueValueInfo(a),a.attr("data-unique-value",b?b.value:null)))}},_drawShape:function(a,b,c,d){a=a.geometry;var e=a.type,f=this._map,g=f.extent,h=f.width,k=f.height,f=f.__visibleRect,l=[],p,n;p="extent"===e;if("rect"===
e||p)l={x:0,y:0,spatialReference:a.spatialReference},l.x=p?a.xmin:a.x,l.y=p?a.ymax:a.y,e=K.toScreenPoint(g,h,k,l),l.x=p?a.xmax:a.x+a.width,l.y=p?a.ymin:a.y+a.height,a=K.toScreenPoint(g,h,k,l),b={x:e.x-f.x+b[0],y:e.y-f.y,width:Math.abs(a.x-e.x),height:Math.abs(a.y-e.y)},0===b.width&&(b.width=1),0===b.height&&(b.height=1),d=this._drawRect(c,d,b);else if("polyline"===e||"polygon"===e){p=0;for(n=b.length;p<n;p++)l=l.concat(K._toScreenPath(g,h,k,a,-f.x+b[p],-f.y));d=this._drawPath(c,d,l);this._rendererLimits&&
("polyline"===e?this._clipPolyline(d,a):this._clipPolygon(d,a))}return d},_drawRect:function(a,b,c){return b?b.setShape(c):a.createRect(c)},_drawImage:function(a,b,c){return b?b.setShape(c):a.createImage(c)},_drawCircle:function(a,b,c){return b?b.setShape(c):a.createCircle(c)},_drawPath:function(){return t?function(a,b,c,d){c=d?c:c.join(" ");if(b)return b.setShape(c);b=a.createObject(d?A.Path:A.EsriPath,c);a._overrideSize(b.getEventSource());return b}:function(a,b,c,d){c=d?c:c.join(" ");return b?
b.setShape(c):a.createPath(c)}}(),_drawText:function(a,b,c){return b?b.setShape(c):a.createText(c)},_evalSDRenderer:function(){var a=this._map,b=this.renderer,c;a&&(a.loaded&&b&&b.getRendererInfo)&&(c="zoom"===b.rangeType?b.getRendererInfoByZoom(a.getZoom()):b.getRendererInfoByScale(a.getScale()));this._rndForScale=c&&c.renderer},_getRenderer:function(a){var b=this._rndForScale||this.renderer;a&&(b&&b.getObservationRenderer)&&(b=b.getObservationRenderer(a));return b},_getSymbol:function(a){var b=
this._getRenderer();return a.symbol||b&&b.getSymbol(a)},_symbolizeShape:function(a,b,c,d){var e=b._stroke,f=b._fill,g=b.type,h,k,l=c&&c.proportionalSymbolInfo?c.getSize(d):null;if(null===e||null===f)e=b._stroke=b.getStroke(),f=b._fill=b.getFill();c&&(c.colorInfo&&"picturefillsymbol"!==g)&&(b=c.getColor(d),-1!==g.indexOf("linesymbol")?h=b:f&&f.toCss&&(k=b));a.setStroke(null==l&&!h?e:y.mixin({},e,l&&{width:l},h&&{color:h})).setFill(k||f)},_smsToPath:function(){return t?function(a,b,c,d,e,f,g,h,k){switch(b){case a.STYLE_SQUARE:return["M",
e+","+g,"L",f+","+g,f+","+h,e+","+h,"X","E"];case a.STYLE_CROSS:return["M",c+","+g,"L",c+","+h,"M",e+","+d,"L",f+","+d,"E"];case a.STYLE_X:return["M",e+","+g,"L",f+","+h,"M",e+","+h,"L",f+","+g,"E"];case a.STYLE_DIAMOND:return["M",c+","+g,"L",f+","+d,c+","+h,e+","+d,"X","E"];case a.STYLE_TARGET:return["M",e+","+g,"L",f+","+g,f+","+h,e+","+h,e+","+g,"M",e-k+","+d,"L",e+","+d,"M",c+","+(g-k),"L",c+","+g,"M",f+k+","+d,"L",f+","+d,"M",c+","+(h+k),"L",c+","+h,"E"]}}:function(a,b,c,d,e,f,g,h,k){switch(b){case a.STYLE_SQUARE:return["M",
e+","+g,f+","+g,f+","+h,e+","+h,"Z"];case a.STYLE_CROSS:return["M",c+","+g,c+","+h,"M",e+","+d,f+","+d];case a.STYLE_X:return["M",e+","+g,f+","+h,"M",e+","+h,f+","+g];case a.STYLE_DIAMOND:return["M",c+","+g,f+","+d,c+","+h,e+","+d,"Z"];case a.STYLE_TARGET:return["M",e+","+g,f+","+g,f+","+h,e+","+h,e+","+g,"M",e-k+","+d,e+","+d,"M",c+","+(g-k),c+","+g,"M",f+k+","+d,f+","+d,"M",c+","+(h+k),c+","+h]}}}(),_pathStyles:{square:1,cross:1,x:1,diamond:1,target:1},_typeMaps:{picturemarkersymbol:"image",picturefillsymbol:"path",
simplefillsymbol:"path",simplelinesymbol:"path",cartographiclinesymbol:"path",textsymbol:"text"},_isInvalidShape:function(a,b){var c=b&&b.shape&&b.shape.type,d=a&&a.type,e=a&&a.style;d&&(e=this._typeMaps[d]||e);this._pathStyles[e]&&(e="path");return!(!c||!(e&&c!==e))},_drawPoint:function(a,b,c,d,e,f,g){var h=c.type,k=this._map,l=k.__visibleRect,p=K.toScreenPoint(k.extent,k.width,k.height,b).offset(-l.x+e[0],-l.y),k=p.x,l=p.y,n;b=[];var m=f&&f.rotationInfo?f.getRotationAngle(g):null,v=f&&f.proportionalSymbolInfo;
f=v?f.getSize(g,{shape:c.style}):null;m&&b.push(u.rotategAt(m,p));(0!==c.xoffset||0!==c.yoffset)&&b.push(u.translate(c.xoffset,-c.yoffset));0!==c.angle&&b.push(u.rotategAt(c.angle,p));if("simplemarkersymbol"===h)switch(n=c.style,h=Math.round,f=v?f:c.size,n){case w.STYLE_SQUARE:case w.STYLE_CROSS:case w.STYLE_X:case w.STYLE_DIAMOND:c=isNaN(f)?16:f/2;n=this._drawPath(a,d,this._smsToPath(w,n,k,l,h(k-c),h(k+c),h(l-c),h(l+c)));break;case w.STYLE_TARGET:p=c._targetWidth/2;v=c._targetHeight/2;n=this._drawPath(a,
d,this._smsToPath(w,n,k,l,h(k-p),h(k+p),h(l-v),h(l+v),c._spikeSize));break;case w.STYLE_PATH:n=this._drawPath(a,d,c.path,!0);c=n.getBoundingBox();a=this._getScaleMatrix(c,f);(1!==a.xx||1!==a.yy)&&b.push(u.scaleAt(a.xx,a.yy,p));b.push(u.translate(-(c.x+c.width/2)+k,-(c.y+c.height/2)+l));break;default:c=isNaN(f)?16:f/2,n=this._drawCircle(a,d,{cx:k,cy:l,r:c})}else"shieldlabelsymbol"===h?(n=c.width,p=c.height,d=a.createGroup(),n=a.createImage({x:k-n/2,y:l-p/2,width:n,height:p,src:c.url}),d.add(n),null!=
c.font&&(l+=0.2*c.getHeight(),a=a.createText({type:"text",text:c.text,x:k,y:l,align:"middle",decoration:c.decoration,rotated:c.rotated,kerning:c.kerning}),a.setFont(c.font),a.setFill(c.color),d.add(a)),n=d):"picturemarkersymbol"===h?(n=v?f:c.width,p=v?f:c.height,n=this._drawImage(a,d,{x:k-n/2,y:l-p/2,width:n,height:p,src:c.url})):"textsymbol"===h&&(n=this._drawText(a,d,{type:"text",text:c.text,x:k,y:l,align:c.getSVGAlign(),decoration:c.decoration||c.font&&c.font.decoration,rotated:c.rotated,kerning:c.kerning}),
M&&(a=n.getNode(),k=c.getSVGBaseline(),c=c.getSVGBaselineShift(),a&&(a.setAttribute("dominant-baseline",k),c&&a.setAttribute("baseline-shift",c))));n.setTransform(u.multiply(b));n._wrapOffsets=e;return n},_getScaleMatrix:function(a,b){var c=a.width/a.height,d=1,e=1;isNaN(b)||(1<c?(d=b/a.width,e=b/c/a.height):(e=b/a.height,d=b*c/a.width));return{xx:d,yy:e}},_symbolizePoint:function(a,b,c,d){var e=b.type;if(!("shieldlabelsymbol"===e||"picturemarkersymbol"===e)){var f=b._stroke,g=b._fill,h=c&&c.colorInfo;
if("textsymbol"===e)a.setFont(b.font).setFill(b.getFill());else{if(null===f||null===g)f=b._stroke=b.getStroke(),g=b._fill=b.getFill();"simplemarkersymbol"===e&&a.setFill(h?c.getColor(d):g).setStroke(f)}}},_drawMarkers:function(a,b,c,d){var e=a.geometry,f=e.points,g=a.getDojoShape()||this._div.createGroup(),h,k,l=f.length,p=[],n=0,m,v=c?c.length:0;g.children[0]&&this._isInvalidShape(b,g.children[0])&&g.clear();for(k=0;k<l;k++){h=f[k];for(m=0;m<v;m++)p[0]=c[m],this._drawPoint(g,{x:h[0],y:h[1],spatialReference:e.spatialReference},
b,g.children[n++],p,d,a)}b=g.children.length;if(l*c.length<b)for(k=b-1;k>=l*c.length;k--)g.children[k].removeShape();a._shape=g},_symbolizeMarkers:function(a,b,c){var d=a.getDojoShape().children,e,f=d.length;for(e=0;e<f;e++)this._symbolizePoint(d[e],b,c,a)},_errorHandler:function(a,b){a.message=b?"Unable to draw graphic (geometry:"+(b.geometry?b.geometry.declaredClass:null)+", symbol:"+(b.symbol?b.symbol.declaredClass:null)+"): "+a.message:"Unable to draw graphic (null): "+a.message;this.inherited(arguments)},
_rendererLimits:function(){var a,b,c;H("ff")?(a=16125,b=-32250,c=32250):t?(a=1E5,b=-1E5,c=1E5):H("chrome")&&6>H("chrome")&&(a=8150,b=-1E4,c=1E4);if(a)return{clipLimit:a,rangeMin:b,rangeMax:c,clipBBox:[-a,-a,a,a],clipSegments:[[[-a,-a],[a,-a]],[[a,-a],[a,a]],[[a,a],[-a,a]],[[-a,a],[-a,-a]]]}}(),_clipPolyline:function(a,b){var c=this._getCorners(a,b),d=c.br,e=this._rendererLimits,f=e.rangeMin,g=e.rangeMax,h=e.clipBBox,k=e.clipSegments,e=this._isPointWithinRange,l=this._isPointWithinBBox,p=this._getClipperIntersection,
n=this._getPlaneIndex;if(!e(c.tl,f,g)||!e(d,f,g)){t&&this._createSegments(a);var q=[];m.forEach(a.segments,function(a){a=a.args;var c=a.length,b=[],e;for(e=0;e<c;e+=2){var d=[a[e],a[e+1]],f=[a[e+2],a[e+3]],g=l(d,h),m=l(f,h);if(g^m){if(m=p([d,f],k))g?(e?b.push(m[1]):b.push(d,m[1]),q.push(b),b=[]):b.push(m[1],f)}else g?e?b.push(f):b.push(d,f):(m=n(d,h),g=n(f,h),-1===m||(-1===g||m===g)||(d=p([d,f],k,!0),0<d.length&&(d[m]||(m=d[m[0]]?m[0]:m[1]),d[g]||(g=d[g[0]]?g[0]:g[1]),f=d[m],d=d[g],f&&b.push(f),d&&
(b.push(d),q.push(b),b=[]))))}q.push(b)});a.setShape(this._getPathStringFromPaths(q))}},_clipPolygon:function(a,b){var c=this._getCorners(a,b),d=c.br,e=this._rendererLimits,f=e.clipLimit,g=e.rangeMin,h=e.rangeMax,k=e.clipBBox,l=e.clipSegments,e=this._isPointWithinRange,p=this._isPointWithinBBox,n=this._getClipperIntersection,q=this._getPlaneIndex,v=R._pointLineDistance;if(!e(c.tl,g,h)||!e(d,g,h))t&&this._createSegments(a),c=m.map(a.segments,function(a){var b=a.args,c=b.length,d=[];a=[];var e;for(e=
0;e<c;e+=2){var g=[b[e],b[e+1]],h=[b[e+2],b[e+3]];if(e===c-2){d.push(g);break}var s=p(g,k),r=p(h,k);d.push(g);if(s^r){if(r=n([g,h],l))g=r[1],g[s?"inOut":"outIn"]=!0,d.push(g),a.push([s?"INOUT":"OUTIN",d.length-1,r[0]])}else if(!s){var s=q(g,k),z=q(h,k);-1===s||(-1===z||s===z)||(r=n([g,h],l,!0),0<r.length?(r[s]||(s=r[s[0]]?s[0]:s[1]),r[z]||(z=r[z[0]]?z[0]:z[1]),g=r[s],h=r[z],g&&(g.outIn=!0,d.push(g),a.push(["OUTIN",d.length-1,s])),h&&(h.inOut=!0,d.push(h),a.push(["INOUT",d.length-1,z]))):y.isArray(s)&&
y.isArray(z)&&(r=s.concat(z),r.sort(),"0123"===r.join("")&&(r=[],3===s[0]+s[1]?r.push([f,-f],[-f,f]):r.push([-f,-f],[f,f]),s=v(r[0],[g,h]),g=v(r[1],[g,h]),d.push(s<g?r[0]:r[1]))))}}var t=k[0],u=k[1],w=k[2],x=k[3];m.forEach(d,function(a){a[0]<t&&(a[1]>=u&&a[1]<=x?a[0]=t:(a[0]=t,a[1]=a[1]<u?u:x))});m.forEach(d,function(a){a[1]<u&&(a[0]>=t&&a[0]<=w?a[1]=u:(a[1]=u,a[0]=a[0]<t?t:w))});m.forEach(d,function(a){a[0]>w&&(a[1]>=u&&a[1]<=x?a[0]=w:(a[0]=w,a[1]=a[1]<u?u:x))});m.forEach(d,function(a){a[1]>x&&(a[0]>=
t&&a[0]<=w?a[1]=x:(a[1]=x,a[0]=a[0]<t?t:w))});b=0;c=a.length;if(0<c){do{h=a[b];e=a[(b+1)%c];if(h[2]===e[2]&&"INOUT"===h[0]&&"OUTIN"===e[0])if(g=h[1],e=e[1],g<e)for(g+=1;g<e;g++)d[g][2]=!0;else if(g>e){for(g+=1;g<d.length;g++)d[g][2]=!0;for(g=0;g<e;g++)d[g][2]=!0}b=(b+1)%c}while(0!==b)}c=d[0];b=d[d.length-1];c[2]&&(b[2]=!0,m.some(a,function(a){return 1===a[1]?(d.splice(d.length-1,0,y.clone(d[1])),!0):!1}));d=m.filter(d,function(a){return a[2]?!1:!0});for(b=0;b<d.length-1;b++)if(c=d[b],(e=d[b+1])&&
!(c[0]!==e[0]||c[1]!==e[1]))e.outIn?c.outIn=!0:e.inOut&&(c.inOut=!0),d.splice(b+1,1);c=Math.abs;a=[];for(b=0;b<d.length-1;b++){h=d[b];g=h[0];h=h[1];s=c(g)===f;r=c(h)===f;e=d[b+1];z=e[0];e=e[1];var A=c(z)===f,B=c(e)===f;s&&B?a.push([b+1,[g,e]]):r&&A&&a.push([b+1,[z,h]])}for(b=a.length-1;0<=b;b--)e=a[b],g=d[e[0]-1],c=d[e[0]],!g.outIn&&(!g.inOut&&!c.outIn&&!c.inOut)&&d.splice(e[0],0,e[1]);c=d[0];b=d[d.length-1];(c[0]!==b[0]||c[1]!==b[1])&&d.push(c);return d}),a.setShape(this._getPathStringFromPaths(c))},
_getCorners:function(a,b){if(t){var c=this._map,d=b.getExtent(),e=d.spatialReference,f=c.toScreen(new Q(d.xmin,d.ymax,e)),c=c.toScreen(new Q(d.xmax,d.ymin,e));return{tl:f,br:c}}f=a.getTransformedBoundingBox();return{tl:f[0],br:f[2]}},_createSegments:function(a){a.shape.path=a.vmlPath;a.segmented=!1;a._confirmSegmented();var b=a.segments;1<b.length&&(a.segments=m.filter(b,function(a,b,e){b=e[b+1];return"M"===a.action&&b&&"L"===b.action?(a.args=a.args.concat(b.args),!0):!1}))},_getPathStringFromPaths:function(a){t?
(a=m.map(a,function(a){return"m "+m.map(a,function(a,b){return(1===b?"l ":"")+a.join(",")}).join(" ")}),a.push("e")):a=m.map(a,function(a){return"M "+m.map(a,function(a){return a.join(",")}).join(" ")});return a.join(" ")},_isPointWithinBBox:function(a,b){var c=b[1],d=b[2],e=b[3],f=a[0],g=a[1];return f>b[0]&&f<d&&g>c&&g<e?!0:!1},_isPointWithinRange:function(a,b,c){var d=a.x;a=a.y;return d<b||a<b||d>c||a>c?!1:!0},_getClipperIntersection:function(a,b,c){var d,e=R._getLineIntersection2,f=Math.round,
g={length:0};for(d=0;4>d;d++){var h=e(a,b[d]);if(h)if(h[0]=f(h[0]),h[1]=f(h[1]),c)g[d]=h,g.length++;else return[d,h]}return c?g:null},_getPlaneIndex:function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1],g=b[2],h=b[3];return c<=e?d>=f&&d<=h?3:d<f?[0,3]:[2,3]:d<=f?c>=e&&c<=g?0:c<e?[3,0]:[1,0]:c>=g?d>=f&&d<=h?1:d<f?[0,1]:[2,1]:d>=h?c>=e&&c<=g?2:c<e?[3,2]:[1,2]:-1},onGraphicAdd:function(){},onGraphicRemove:function(){},onGraphicNodeAdd:function(){},onGraphicNodeRemove:function(){},onGraphicDraw:function(){},
onGraphicsClear:function(){},onRendererChange:function(){},onOpacityChange:function(){},setInfoTemplate:function(a){this.infoTemplate=a},add:function(a,b){if(a._graphicsLayer===this)return a;b||this.graphics.push(a);a._graphicsLayer=this;this._updateExtent(a);this._draw(a);if(!b)this.onGraphicAdd(a);return a},remove:function(a,b){if(!b){var c;if(-1===(c=m.indexOf(this.graphics,a)))return null;a=this.graphics.splice(c,1)[0]}a.getDojoShape()&&this._removeShape(a);a._shape=a._graphicsLayer=null;this.onGraphicRemove(a);
return a},clear:function(a,b){for(var c=this.graphics;0<c.length;)this.remove(c[0]);if(!b)this.onGraphicsClear()},_setIEOpacity:function(a,b){var c=a&&a.getNode();if(c){var d=a.strokeStyle,e=c.stroke;d&&e&&(e.opacity=d.color.a*b);d=a.fillStyle;e=c.fill;d&&e&&("tile"===e.type?G.set(c,"opacity",b):e.opacity=d.a*b)}},setOpacity:function(a,b){if(b||this.opacity!=a){var c=this._div;c&&(t?(m.forEach(this.graphics,function(b){this._setIEOpacity(b._shape,a);this._setIEOpacity(b._bgShape,a)},this),c._esriIeOpacity=
a,this._bgGroup._esriIeOpacity=a):this._canvas?G.set(c.getEventSource(),"opacity",a):c.getEventSource().setAttribute("opacity",a));this.opacity=a;if(!b)this.onOpacityChange(a)}},setRenderer:function(a){this.renderer=a;this._evalSDRenderer();this.onRendererChange()}});x=x(L,{declaredClass:"esri.layers.GraphicsLayer",constructor:function(){this.enableMouseEvents=y.hitch(this,this.enableMouseEvents);this.disableMouseEvents=y.hitch(this,this.disableMouseEvents);this._processEvent=y.hitch(this,this._processEvent);
this._initLayer()},_initLayer:function(){this.loaded=!0;this.onLoad(this)},_setMap:function(){var a=this.inherited("_setMap",arguments);this.enableMouseEvents();return a},_unsetMap:function(){this.disableMouseEvents();this.inherited("_unsetMap",arguments)},_processEvent:function(a){var b=this._map,c=a.target,d;a.screenPoint=new J(a.pageX-b.position.x,a.pageY-b.position.y);for(a.mapPoint=b.toMap(a.screenPoint);c&&!(d=c.e_graphic);)c=c.parentNode;if(d)return a.graphic=d,a},_onMouseOverHandler:function(a){if(this._processEvent(a))this.onMouseOver(a)},
_onMouseMoveHandler:function(a){if(this._processEvent(a))this.onMouseMove(a)},_onMouseDragHandler:function(a){if(this._processEvent(a))this.onMouseDrag(a)},_onMouseOutHandler:function(a){if(this._processEvent(a))this.onMouseOut(a)},_onMouseDownHandler:function(a){this._downGr=this._downPt=null;this._processEvent(a)&&(q.disconnect(this._onmousemove_connect),q.disconnect(this._onmousedrag_connect),this._onmousedrag_connect=q.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseDragHandler"),
this._downGr=a.graphic,this._downPt=a.screenPoint.x+","+a.screenPoint.y,this.onMouseDown(a))},_onMouseUpHandler:function(a){this._upGr=this._upPt=null;this._processEvent(a)&&(q.disconnect(this._onmousedrag_connect),q.disconnect(this._onmousemove_connect),this._onmousemove_connect=q.connect(this._div.getEventSource(),"onmousemove",this,"_onMouseMoveHandler"),this._upGr=a.graphic,this._upPt=a.screenPoint.x+","+a.screenPoint.y,this.onMouseUp(a))},_onClickHandler:function(a){if(this._processEvent(a)){var b=
this._downGr,c=this._upGr;b&&(c&&b===c&&this._downPt===this._upPt)&&(t&&(T._ieGraphic=a.graphic),this.onClick(a))}},_onDblClickHandler:function(a){if(this._processEvent(a))this.onDblClick(a)},onMouseOver:function(){},onMouseMove:function(){},onMouseDrag:function(){},onMouseOut:function(){},onMouseDown:function(){},onMouseUp:function(){},onClick:function(){},onDblClick:function(){},enableMouseEvents:function(){if(!this._mouseEvents){var a=q.connect,b=this._div.getEventSource();D||(this._onmouseover_connect=
a(b,"onmouseover",this,"_onMouseOverHandler"),this._onmousemove_connect=a(b,"onmousemove",this,"_onMouseMoveHandler"),this._onmouseout_connect=a(b,"onmouseout",this,"_onMouseOutHandler"),this._onmousedown_connect=a(b,"onmousedown",this,"_onMouseDownHandler"),this._onmouseup_connect=a(b,"onmouseup",this,"_onMouseUpHandler"),this._onclick_connect=a(b,"onclick",this,"_onClickHandler"),this._ondblclick_connect=a(b,"ondblclick",this,"_onDblClickHandler"));this._mouseEvents=!0}},disableMouseEvents:function(){if(this._mouseEvents){var a=
q.disconnect;a(this._onmouseover_connect);a(this._onmousemove_connect);a(this._onmousedrag_connect);a(this._onmouseout_connect);a(this._onmousedown_connect);a(this._onmouseup_connect);a(this._onclick_connect);a(this._ondblclick_connect);this._mouseEvents=!1}}});x._GraphicsContainer=W;x._GraphicsLayer=L;return x});